#!/bin/mksh

select_player() {
  playing=""
  for p in $1; do
    if [ $(playerctl -p "$p" status) == "Playing" ]; then
      [ -z "$playing" ] && playing="$p" || playing="$playing\n$p"
    fi
  done
  case $(echo "$playing" | wc -l) in
    0) exit ;;
    1) echo "$playing" ;;
    *) echo $(echo "$playing" | ${DMENU}) ;;
  esac
}

prompt() {
  a=$(playerctl -p $1 metadata xesam:artist)
  t=$(playerctl -p $1 metadata xesam:title)
  if [ -n "$a" -a -n "$t" ]; then
    echo "$1: $a - $t"
  else
    echo "$1:"
  fi
}

play_pause() {
  [ $(playerctl -p $1 status) == "Playing" ] && echo "Pause" || echo "Play"
}

player_menu() {
  [ -z "$1" ] && exit
  CMDS="$(play_pause $1)\nStop\nNext\nPrevious\nVolume"
  ret=$(echo $CMDS | ${DMENU} -p "$(prompt $1)" -i | tr '[A-Z]' '[a-z]')
  case "$ret" in
    play|pause|next|previous) playerctl -p $1 $ret ;;
    volume) volume_menu $1 ;;
  esac
}

volume_menu() {
  cmds="Up\nDown"
  while :
  do
    vol=$(echo "$(playerctl -p $1 volume) * 100" | bc)
    vol=${vol%.*}
    ret=$(echo "$cmds" | ${DMENU} -p "$1: $vol" -i | tr '[A-Z]' '[a-z]')
    case "$ret" in
      up)
        playerctl -p $1 volume $(echo "($vol + 5) / 100" | bc -l)
        cmds="Up\nDown"
      ;;
      down)
        playerctl -p $1 volume $(echo "($vol - 5) / 100" | bc -l)
        cmds="Down\nUp"
      ;;
      *)
        [ -z "$ret" ] && break
        [ -n "$(echo $ret | tr -d '[[:digit:]]')" ] && break
        playerctl -p $1 volume $(echo "$ret / 100" | bc -l)
        if [ "$ret" -gt "$vol" ]; then
          cmds="Up\nDown"
        else
          cmds="Down\nUp"
        fi
      ;;
    esac
  done
}

: ${DMENU:=dmenu}
: ${PLAYER:=$(playerctl -l)}
case "$(echo ${PLAYER} | wc -w)" in
  0) echo "No player running" && exit ;;
  1) player_menu "$PLAYER" ;;
  *) player_menu $(select_player "$PLAYER") ;;
esac
